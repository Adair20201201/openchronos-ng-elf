machine:
  environment:
    MSP430_TI: $HOME/msp430-elf-gcc
    PATH: $PATH:$MSP430_TI/bin

  pre:
    - echo alias ll=\'ls -al\' >> ~/.bash_profile    # setup ll alias for later ssh login

dependencies:
  pre:
    # Install github release go package
    - echo $GOPATH
    - if [ ! -e $GOPATH/bin/github-release ]; then go get github.com/BenjaminSoelberg/github-release; fi
    # Downloading msp430 elf gcc compiler...
    - wget https://circle-artifacts.com/gh/BenjaminSoelberg/msp430-elf/4/artifacts/0/tmp/circle-artifacts.QiqE80U/msp430-elf-gcc-without-mspdebug_3.05.00.00_ubuntu_x64.tar.gz -O $HOME/msp430-elf-gcc.tar.gz

    # Installing msp430 elf gcc compiler...
    - cd $HOME && tar xvf msp430-elf-gcc.tar.gz | tail

  override:
    - # Cleaning openchronos-ng-elf...
    - make clean        # Clean the openchronos-ng-elf project

    # Building openchronos-ng-elf...
    - make              # Build the openchronos-ng-elf project

  post:
    # Build a firmware pre-release package
    - tar -cvzf openchronos-ng-elf-latest-firmware.tgz openchronos.txt openchronos.elf README.md
    # Delete LATEST pre-release if exists (the || true part ensures that circleci doesn't fail on first run where LATEST doesn't exisis
    - github-release delete -s $GITHUB_USER_TOKEN -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME -t LATEST || true
    # Create LATEST pre-release
    - github-release release -s $GITHUB_USER_TOKEN -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME -t LATEST -n "Latest snapshot" -d "This is the latest snapshot build by CircleCI." -c $CIRCLE_BRANCH -p
    # Attach pre-release firmware package
    - github-release upload -s $GITHUB_USER_TOKEN -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME -t LATEST -n "openchronos-ng-elf-latest-firmware.tgz" -l "openchronos-ng-elf-latest-firmware.tgz" -f openchronos-ng-elf-latest-firmware.tgz

    # No need for caching of source or downloaded packages
    - rm -rf $GOPATH/src $GOPATH/pkg

test:
  override:
    - echo notests yet

general:
  artifacts:
    - "openchronos-ng-elf-latest-firmware.tgz" # post snapshot release to circleci
